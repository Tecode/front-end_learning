# 1ã€å¾®å‰ç«¯æ¦‚è¿°

## 1.1 ä»€ä¹ˆæ˜¯å¾®å‰ç«¯

å¾®å‰ç«¯æ˜¯ä¸€ç§è½¯ä»¶æ¶æ„ï¼Œå¯ä»¥å°†å‰ç«¯åº”ç”¨æ‹†è§£æˆä¸€äº›æ›´å°çš„èƒ½å¤Ÿç‹¬ç«‹å¼€å‘éƒ¨ç½²çš„å¾®å‹åº”ç”¨ï¼Œç„¶åå†å°†è¿™
äº›å¾®åº”ç”¨è¿›è¡Œç»„åˆä½¿å…¶æˆä¸ºæ•´ä½“åº”ç”¨çš„æ¶æ„æ¨¡å¼ã€‚
å¾®å‰ç«¯æ¶æ„ç±»ä¼¼äºç»„ä»¶æ¶æ„ï¼Œä½†ä¸åŒçš„æ˜¯ï¼Œç»„ä»¶ä¸èƒ½ç‹¬ç«‹æ„å»ºå’Œå‘å¸ƒï¼Œä½†æ˜¯å¾®å‰ç«¯ä¸­çš„åº”ç”¨æ˜¯å¯ä»¥çš„ã€‚
å¾®å‰ç«¯æ¶æ„ä¸æ¡†æ¶æ— å…³ï¼Œæ¯ä¸ªå¾®åº”ç”¨éƒ½å¯ä»¥ä½¿ç”¨ä¸åŒçš„æ¡†æ¶ã€‚

## 1.2 å¾®å‰ç«¯çš„ä»·å€¼
**å¢é‡è¿ç§»**

**ç‹¬ç«‹å‘å¸ƒ**

**å…è®¸å•ä¸ªå›¢é˜Ÿåšå‡ºæŠ€æœ¯å†³ç­–**

å› ä¸ºå¾®å‰ç«¯æ„æ¶ä¸æ¡†æ¶æ— å…³ï¼Œå½“ä¸€ä¸ªåº”ç”¨ç”±å¤šä¸ªå›¢é˜Ÿè¿›è¡Œå¼€å‘æ—¶ï¼Œæ¯ä¸ªå›¢é˜Ÿéƒ½å¯ä»¥ä½¿ç”¨è‡ªå·±æ“…é•¿çš„æŠ€æœ¯æ ˆè¿›è¡Œå¼€å‘ï¼Œä¹Ÿå°±æ˜¯å®ƒå…è®¸é€‚å½“çš„è®©å›¢é˜Ÿå†³ç­–ä½¿ç”¨å“ªç§æŠ€æœ¯ï¼Œä»è€Œä½¿å›¢é˜Ÿåä½œå˜å¾—ä¸å†åƒµç¡¬ã€‚

### å¾®å‰ç«¯çš„ä½¿ç”¨åœºæ™¯

1. æ‹†åˆ†å·¨å‹åº”ç”¨ï¼Œä½¿åº”ç”¨å˜å¾—æ›´åŠ å¯ç»´æŠ¤
2. å…¼å®¹å†å²åº”ç”¨ï¼Œå®ç°å¢é‡å¼€å‘

## 1.3 å¤šä¸ªå¾®åº”ç”¨å¦‚ä½•è¿›è¡Œç»„åˆ ?

1. å¤šä¸ªå¾®åº”ç”¨å¦‚ä½•è¿›è¡Œç»„åˆ ?
   åœ¨å¾®å‰ç«¯æ¶æ„ä¸­ï¼Œé™¤äº†å­˜åœ¨å¤šä¸ªå¾®åº”ç”¨ä»¥å¤–ï¼Œè¿˜å­˜åœ¨ä¸€ä¸ªå®¹å™¨åº”ç”¨ï¼Œæ¯ä¸ªå¾®åº”ç”¨éƒ½éœ€è¦è¢«æ³¨å†Œåˆ°å®¹ å™¨åº”ç”¨ä¸­ã€‚ å¾®å‰ç«¯ä¸­çš„æ¯ä¸ªåº”ç”¨åœ¨æµè§ˆå™¨ä¸­éƒ½æ˜¯ä¸€ä¸ªç‹¬ç«‹çš„ JavaScript æ¨¡å—ï¼Œé€šè¿‡æ¨¡å—åŒ–çš„æ–¹å¼è¢«å®¹å™¨åº”ç”¨å¯ åŠ¨å’Œè¿è¡Œã€‚ ä½¿ç”¨æ¨¡å—åŒ–çš„æ–¹å¼è¿è¡Œåº”ç”¨å¯ä»¥é˜²æ­¢ä¸åŒçš„å¾®åº”ç”¨åœ¨åŒæ—¶è¿è¡Œæ—¶å‘ç”Ÿå†²çªã€‚
2. åœ¨å¾®åº”ç”¨ä¸­å¦‚ä½•å®ç°è·¯ç”± ï¼Ÿ
   åœ¨å¾®å‰ç«¯æ¶æ„ä¸­ï¼Œå½“è·¯ç”±å‘ç”Ÿå˜åŒ–æ—¶ï¼Œå®¹å™¨åº”ç”¨é¦–å…ˆä¼šæ‹¦æˆªè·¯ç”±çš„å˜åŒ–ï¼Œæ ¹æ®è·¯ç”±åŒ¹é…å¾®å‰ç«¯åº”ç”¨ï¼Œå½“åŒ¹é…åˆ°å¾®åº”ç”¨ä»¥åï¼Œå†å¯åŠ¨å¾®åº”ç”¨è·¯ç”±ï¼ŒåŒ¹é…å…·ä½“çš„é¡µé¢ç»„ä»¶ã€‚
3. å¾®åº”ç”¨ä¸å¾®åº”ç”¨ä¹‹é—´å¦‚ä½•å®ç°çŠ¶æ€å…±äº« ?
   åœ¨å¾®åº”ç”¨ä¸­å¯ä»¥é€šè¿‡å‘å¸ƒè®¢é˜…æ¨¡å¼å®ç°çŠ¶æ€å…±äº«ï¼Œæ¯”å¦‚ä½¿ç”¨ RxJSã€‚ 
4. å¾®åº”ç”¨ä¸å¾®åº”ç”¨ä¹‹é—´å¦‚ä½•å®ç°æ¡†æ¶å’Œåº“çš„å…±äº«ï¼Ÿ 
   é€šè¿‡ import-map å’Œ webpack ä¸­çš„ externals å±æ€§ã€‚

# 2ã€SystemJSæ¨¡å—åŒ–è§£å†³æ–¹æ¡ˆ

## ç¤¾åŒºæ´»è·ƒåº¦

![img.png](picture/img.png)

## ä½¿ç”¨ä½“éªŒ

é€šè¿‡ webpack å°† react åº”ç”¨æ‰“åŒ…ä¸º systemjs æ¨¡å—ï¼Œåœ¨é€šè¿‡ systemjs åœ¨æµè§ˆå™¨ä¸­åŠ è½½æ¨¡å—ã€‚
æ¯”è¾ƒç±»ä¼¼`RequireJS`åªæ˜¯ `RequireJS`æ˜¯åŸºäºAMDè§„èŒƒï¼Œæ˜¯ä¸€ä¸ªæ¨¡å—åŠ è½½çš„æ’ä»¶ã€‚SystemJSæ˜¯ä¸€ä¸ªåŸºäºçš„è‡ªå·±çš„æ¨¡å—è§„èŒƒã€‚

å¦‚æœæˆ‘ä»¬åœ¨å¾ˆå¤šé¡¹ç›®ä¸­æœ‰å…¬ç”¨çš„æ’ä»¶éœ€è¦æ‰“åŒ…æ—¶æ’é™¤`externals: ["react", "react-dom", "react-router-dom"]`å¹¶å°†
å…¬å…±æ¨¡å—æ·»åŠ åˆ°`<script type="systemjs-importmap">`ä¸­è¿›è¡Œå¼•ç”¨ã€‚ä¸ªäººæ„Ÿè§‰å±äºåŠè‡ªåŠ¨åŒ–ï¼Œæˆ‘ä»¬å…±äº«ç»„ä»¶æ—¶å¦‚æœä¿®æ”¹äº†
éœ€è¦å†å»æ‰“åŒ…å¦ä¸€ä¸ªé¡¹ç›®çš„å…¬å…±æ’ä»¶ç„¶åå†æ”¾åˆ°é¡¹ç›®ä¸­ä¼šæ¯”è¾ƒéº»çƒ¦ã€‚

### ç¤ºä¾‹ä»£ç 

```js
const path = require("path")
const HtmlWebpackPlugin = require("html-webpack-plugin")

module.exports = {
  mode: "development",
  entry: "./src/index.js",
  output: {
    filename: "index.js",
    path: path.join(__dirname, "build"),
    libraryTarget: "system"
  },
  devtool: "source-map",
  devServer: {
    port: 9000,
    contentBase: path.join(__dirname, "build"),
    historyApiFallback: true
  },
  module: {
    rules: [
      {
        test: /\.js$/,
        exclude: /node_modules/,
        use: {
          loader: "babel-loader",
          options: {
            presets: ["@babel/preset-env", "@babel/preset-react"]
          }
        }
      }
    ]
  },
  plugins: [
    new HtmlWebpackPlugin({
      template: "./src/index.html",
      inject: false
    })
  ],
  externals: ["react", "react-dom", "react-router-dom"]
}

```

```js
<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <title>SystemJS AMD Modules from CDN Example</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <script type="systemjs-importmap">
    {
      "imports": {
        "react": "https://cdn.jsdelivr.net/npm/react/umd/react.production.min.js",
        "react-dom": "https://cdn.jsdelivr.net/npm/react-dom/umd/react-dom.production.min.js"
      }
    }
  </script>
  <script src="https://cdn.jsdelivr.net/npm/systemjs/dist/system.min.js"></script>
</head>
<body>
  <div id="react-root"></div>
  <script type="systemjs-module" src="./dist/react-hello-world.js"></script>
</body>
</html>
```

# 3ã€åŸºäº`qiankun` `single-spa`å®ç°å¾®å‰ç«¯

## 3.1 æ¦‚è¿°

`qiankun` æ˜¯ä¸€ä¸ªåŸºäº `single-spa` çš„å¾®å‰ç«¯å®ç°åº“ï¼Œæ—¨åœ¨å¸®åŠ©å¤§å®¶èƒ½æ›´ç®€å•ã€æ— ç—›çš„æ„å»ºä¸€ä¸ªç”Ÿäº§å¯ç”¨å¾®å‰ç«¯æ¶æ„ç³»ç»Ÿã€‚è¿™ä¸¤ä¸ªå¾®å‰ç«¯æ¡†æ¶ç”¨æ³•æ¯”è¾ƒ
ç±»ä¼¼ï¼Œæä¾›çš„Apiå’Œ`single-spa`æ˜¯ç±»ä¼¼ã€‚æ¨¡å—åŠ è½½åŸºäº`system.js`ã€‚

- åŸºäº single-spa å°è£…ï¼Œæä¾›äº†æ›´åŠ å¼€ç®±å³ç”¨çš„ APIã€‚
- ğŸ“± æŠ€æœ¯æ ˆæ— å…³ï¼Œä»»æ„æŠ€æœ¯æ ˆçš„åº”ç”¨å‡å¯ ä½¿ç”¨/æ¥å…¥ï¼Œä¸è®ºæ˜¯ React/Vue/Angular/JQuery è¿˜æ˜¯å…¶ä»–ç­‰æ¡†æ¶ã€‚
- ğŸ’ª HTML Entry æ¥å…¥æ–¹å¼ï¼Œè®©ä½ æ¥å…¥å¾®åº”ç”¨åƒä½¿ç”¨ iframe ä¸€æ ·ç®€å•ã€‚
- ğŸ›¡â€‹ æ ·å¼éš”ç¦»ï¼Œç¡®ä¿å¾®åº”ç”¨ä¹‹é—´æ ·å¼äº’ç›¸ä¸å¹²æ‰°ã€‚
- ğŸ§³ JS æ²™ç®±ï¼Œç¡®ä¿å¾®åº”ç”¨ä¹‹é—´ å…¨å±€å˜é‡/äº‹ä»¶ ä¸å†²çªã€‚
- âš¡ï¸ èµ„æºé¢„åŠ è½½ï¼Œåœ¨æµè§ˆå™¨ç©ºé—²æ—¶é—´é¢„åŠ è½½æœªæ‰“å¼€çš„å¾®åº”ç”¨èµ„æºï¼ŒåŠ é€Ÿå¾®åº”ç”¨æ‰“å¼€é€Ÿåº¦ã€‚
- ğŸ”Œ umi æ’ä»¶ï¼Œæä¾›äº† @umijs/plugin-qiankun ä¾› umi åº”ç”¨ä¸€é”®åˆ‡æ¢æˆå¾®å‰ç«¯æ¶æ„ç³»ç»Ÿã€‚

## 3.2qiankunå®ç°

```shell
$ git clone https://github.com/umijs/qiankun.git
$ cd qiankun

$ yarn install
$ yarn examples:install
$ yarn examples:start
```

## 3.3single-spaå®ç°

### single-spa æ¦‚è¿°

single-spa æ˜¯ä¸€ä¸ªå®ç°å¾®å‰ç«¯æ¶æ„çš„æ¡†æ¶ã€‚
åœ¨ single-spa æ¡†æ¶ä¸­æœ‰ä¸‰ç§ç±»å‹çš„å¾®å‰ç«¯åº”ç”¨ï¼š
1. single-spa-application / parcelï¼šå¾®å‰ç«¯æ¶æ„ä¸­çš„å¾®åº”ç”¨ï¼Œå¯ä»¥ä½¿ç”¨ vueã€reactã€angular ç­‰æ¡†æ¶ã€‚
2. single-spa root configï¼šåˆ›å»ºå¾®å‰ç«¯å®¹å™¨åº”ç”¨ã€‚
3. utility modulesï¼šå…¬å…±æ¨¡å—åº”ç”¨ï¼Œéæ¸²æŸ“ç»„ä»¶ï¼Œç”¨äºè·¨åº”ç”¨å…±äº« javascript é€»è¾‘çš„å¾®åº”ç”¨ã€‚

### åˆ›å»ºå®¹å™¨åº”ç”¨

1. å®‰è£… single-spa è„šæ‰‹æ¶å·¥å…·ï¼š npm install create-single-spa@2.0.3 -g
2. åˆ›å»ºå¾®å‰ç«¯åº”ç”¨ç›®å½•ï¼š mkdir application && cd "$_" 
3. åˆ›å»ºå¾®å‰ç«¯å®¹å™¨åº”ç”¨ï¼š create-single-spa 
    - åº”ç”¨æ–‡ä»¶å¤¹å¡«å†™ container
    - åº”ç”¨é€‰æ‹© single-spa root config
    - ç»„ç»‡åç§°å¡«å†™ ebk
    - ç»„ç»‡åç§°å¯ä»¥ç†è§£ä¸ºå›¢é˜Ÿåç§°ï¼Œå¾®å‰ç«¯æ¶æ„å…è®¸å¤šå›¢é˜Ÿå…±åŒå¼€å‘åº”ç”¨ï¼Œç»„ç»‡åç§°å¯ä»¥æ ‡è¯†åº”ç”¨ç”±å“ªä¸ªå›¢é˜Ÿå¼€å‘ã€‚
    - åº”ç”¨åç§°çš„å‘½åè§„åˆ™ä¸º @ç»„ç»‡åç§°/åº”ç”¨åç§° ï¼Œæ¯”å¦‚ @ebk/todos 
4. å¯åŠ¨åº”ç”¨ï¼š npm start 
5. è®¿é—®åº”ç”¨ï¼š localhost:9000

### åˆ›å»ºåŸºäº Vue çš„å¾®åº”ç”¨

1. åˆ›å»ºåº”ç”¨ï¼š create-single-spa 
- é¡¹ç›®æ–‡ä»¶å¤¹å¡«å†™ product
- æ¡†æ¶é€‰æ‹© Vue
- ç”Ÿæˆ Vue 2 é¡¹ç›®

**å°†å…¬ç”¨çš„ä»£ç æå–ä¸æ‰“åŒ…åˆ°é¡¹ç›®ä¸­ï¼Œå¯ä»¥é€šè¿‡CDNæ–¹å¼å¼•ç”¨**

```js
// vue.config.js
module.exports = { chainWebpack: config => { config.externals(["vue", "vue-router"]) } }
```

# 4ã€åŸºäºæ¨¡å—è”é‚¦çš„å¾®åº”ç”¨

## åº”ç”¨åˆå§‹åŒ–

ä½¿ç”¨`Vue cli`çš„è„šæ‰‹æ¶å·¥å…·åˆ›å»ºå®¹å™¨åº”ç”¨ï¼ˆæˆ‘ä»¬çš„æŠ€æœ¯æ ˆæ˜¯vueè¿™é‡Œä»‹ç»vueé¡¹ç›®çš„å¾®åº”ç”¨å¼€å‘ï¼‰ï¼Œå¯åŠ¨åº”ç”¨`yarn serve`ï¼Œè¿™æ—¶æˆ‘ä»¬å°±å¯ä»¥çœ‹åˆ°æˆ‘ä»¬çš„åº”ç”¨ä»¥åŠå¯ä»¥è®¿é—®ã€‚

## 4.1 æ¨¡å—è”é‚¦æ¦‚è¿°

Module Federation å³ä¸ºæ¨¡å—è”é‚¦ï¼Œæ˜¯ Webpack 5 ä¸­æ–°å¢çš„ä¸€é¡¹åŠŸèƒ½ï¼Œå¯ä»¥å®ç°è·¨åº”ç”¨å…±äº«æ¨¡å—ã€‚
Runtime çš„æ–¹å¼å¯èƒ½æ˜¯ UMD æ–¹å¼å…±äº«ä»£ç æ¨¡å—ï¼Œå³å°†æ¨¡å—ç”¨ Webpack UMD æ¨¡å¼æ‰“åŒ…ï¼Œå¹¶è¾“å‡ºåˆ°å…¶ä»–é¡¹ç›®ä¸­ï¼Œè¿è¡Œæ—¶åŠ è½½æ¨¡å—è¿›è¡Œé¡µé¢æ¸²æŸ“ã€‚


## 4.2 å…±äº«æ¨¡å—

### å®ç°æ¨¡å—å…±äº«

åœ¨ Product å’Œ Auth ä¸­éƒ½éœ€è¦åŒä¸€ä¸ªç»„ä»¶çš„æ—¶å€™ï¼Œ Container åŠ è½½äº†è¿™ä¸¤ä¸ªæ¨¡å—åï¼Œä»–ä»¬ä½¿ç”¨çš„æ¨¡å—ä¼šè¢«åŠ è½½äº†ä¸¤æ¬¡ã€‚

```shell
// åˆ†åˆ«åœ¨ Products å’Œ Cart çš„ webpack é…ç½®æ–‡ä»¶ä¸­çš„æ¨¡å—è”é‚¦æ’ä»¶ä¸­æ·»åŠ ä»¥ä¸‹ä»£ç 
{ 
  shared: ["æ¨¡å—åç§°"] 
}
```

æ³¨æ„ï¼šå…±äº«æ¨¡å—éœ€è¦å¼‚æ­¥åŠ è½½ï¼Œéœ€è¦æ·»åŠ  bootstrap.js
### å…±äº«æ¨¡å—ç‰ˆæœ¬å†²çªè§£å†³ 
å¦‚æœä½¿ç”¨ 4.1.0 ç‰ˆæœ¬çš„ fakerï¼Œä¾‹å¦‚ product ä¸­ä½¿ç”¨ 5.2.0 ç‰ˆæœ¬çš„ fakerï¼Œé€šè¿‡æŸ¥çœ‹ç½‘ç»œæ§åˆ¶é¢æ¿å¯ä»¥å‘ç° faker åˆä¼šè¢«åŠ è½½äº†ä¸¤æ¬¡ï¼Œæ¨¡å—å…±äº«å¤±è´¥ã€‚
è§£å†³åŠæ³•æ˜¯åˆ†åˆ«åœ¨ fakerï¼Œproduct å’Œ cart ä¸­çš„ webpack é…ç½®ä¸­åŠ å…¥å¦‚ä¸‹ä»£ç 

```sh
shared: { faker: { singleton: true } }
```

ä½†åŒæ—¶ä¼šåœ¨åŸæœ¬ä½¿ç”¨ä½ç‰ˆæœ¬çš„å…±äº«æ¨¡å—åº”ç”¨çš„æ§åˆ¶å°ä¸­ç»™äºˆè­¦å‘Šæç¤º

### å¼€æ”¾å­åº”ç”¨æŒ‚è½½æ¥å£

åœ¨å®¹å™¨åº”ç”¨å¯¼å…¥å¾®åº”ç”¨åï¼Œåº”è¯¥æœ‰æƒé™å†³å®šå¾®åº”ç”¨çš„æŒ‚è½½ä½ç½®ï¼Œè€Œä¸æ˜¯å¾®åº”ç”¨åœ¨ä»£ç è¿è¡Œæ—¶ç›´æ¥è¿›è¡ŒæŒ‚è½½ã€‚æ‰€ä»¥æ¯ä¸ªå¾®åº”ç”¨éƒ½åº”è¯¥å¯¼å‡ºä¸€ä¸ªæŒ‚è½½æ–¹æ³•ä¾›å®¹å™¨åº”ç”¨è°ƒç”¨ã€‚

```js
exposes: {
 "./HelloWorld": "./src/components/HelloWorld",
 "./ProductApp": "./src/bootstrap.js",
},
```

# é”™è¯¯ä¿¡æ¯

### ScriptExternalLoadError: Loading script failed
```sh
app.js:29 Uncaught (in promise) ScriptExternalLoadError: Loading script failed.
(missing: http://localhost:9001/remoteEntry.js)
while loading "./HelloWorld" from webpack/container/reference/product
    at Object.webpack/container/reference/product (app.js:29:25)
    at __webpack_require__ (app.js:71:33)
    at initExternal (app.js:381:28)
    at Function.__webpack_require__.I (app.js:393:15)
    at app.js:867:47
    at Object.webpack/sharing/consume/default/vue/vue (app.js:921:76)
    at app.js:948:56
    at Array.forEach (<anonymous>)
    at Object.__webpack_require__.f.consumes (app.js:931:36)
    at app.js:186:40

    chainWebpack: (config) => {
    // ç§»é™¤splitChunksï¼Œä½¿ç”¨æ—¶æ— æ³•æ‰¾åˆ°æ¨¡å—
    config.optimization.delete("splitChunks");
    /* module federation plugin import */
    config.plugin("module-federation-plugin").use(ModuleFederationPlugin, [
      {
        name: "container",
        filename: "remoteEntry.js",
        remotes: {
          auth: "auth@http://localhost:9002/remoteEntry.js",
          product: "product@http://localhost:9001/remoteEntry.js",
        },
        shared: require("./package.json").dependencies,
      },
    ]);
  }
```

## æ•°æ®ã€æ–¹æ³•å…±äº«
ç»„ä»¶åœ¨å®¹å™¨ä¹Ÿæœ‰æ•°æ®å…±äº«ï¼Œå­æ¨¡å—å¯ä»¥å¯¼å…¥å®¹å™¨åº”ç”¨æ•°æ®æˆ–è€…æ¨¡å—
## æ ·å¼éš”ç¦»
ä¸ºäº†é¿å…CssåŒåéœ€è¦ä¸ºæ ·å¼åŠ å‰ç¼€æˆ–è€…ä½œç”¨åŸŸ
## CssæŒ‰éœ€åŠ è½½
Cssæ‰“åŒ…æˆ‘ä»¬ä¹‹å‰çš„é¡¹ç›®ä¼šå°†æ‰€æœ‰çš„æ ·å¼æ”¾åœ¨ä¸€ä¸ªä¸€èµ·æœ€åè¿™æ ·ä¼šå¯¼è‡´åŠ è½½è¿‡ç¨‹ä¸­å…¨é‡åŠ è½½ï¼Œå°†Cssæ‹†åˆ†ä¸º
æ¨¡å—æŒ‰éœ€åŠ è½½åªä¼šåœ¨è®¿é—®å¯¹åº”æ¨¡å—åŠ è½½å¯¹åº”çš„Cssã€‚